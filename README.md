# 仓库设计系统

基于 Python Flask 和 Three.js 的 3D 仓库可视化设计系统，支持货架布局配置、SKU 管理、货物放置、环境设计和实时数据统计。

## 功能特性

### 🎯 核心功能

#### 1. 货架管理
- **货架布局设计**: 支持创建、编辑、删除货架单元
- **批量操作**: 初始化默认布局、批量添加货架
- **精确控制**: 
  - 位置调整（X/Z 坐标精确输入、拖拽移动）
  - 尺寸控制（宽度、高度、深度精确设置）
  - 对齐功能（前、后、左、右对齐）
  - 等距分布（水平、垂直等距）
  - 旋转操作（90度旋转）
- **格口管理**: 可配置每个货架的格口数量
- **四级标识系统**: 库区、货架、层、格口四级标识

#### 2. SKU 管理（货物种类）
- **SKU 配置**: 创建和管理货物种类
- **基本信息**: 名称、编码、尺寸（长宽高）、重量
- **图片管理**: 
  - 单张图片上传
  - 多面贴图（6个面：上、下、前、后、左、右）
  - 自动生成缩略图
  - 合成展开图预览
- **数据库存储**: 使用 SQLite 存储 SKU 数据
- **批量操作**: 支持批量删除 SKU

#### 3. 货物管理
- **货物放置**: 在 3D 场景中放置货物
- **智能定位**: 自动检测支撑面（货架层板、其他货物）
- **物理模拟**: 货物自动堆叠，支持重力效果
- **位置控制**: 精确控制货物在场景中的位置和旋转
- **SKU 关联**: 每个货物关联到对应的 SKU

#### 4. 环境设计
- **空间配置**: 可配置仓库空间尺寸（长度、宽度）
- **地板与网格**: 
  - 自定义地板颜色
  - 网格颜色配置（双色网格）
  - 网格显示/隐藏
- **环境零件**:
  - **墙面**: 支持划线创建连续墙面
  - **楼梯**: 直梯、双跑楼梯、旋转楼梯
  - **出库口**: 装卸货平台
  - **厕所**: 卫生间设施
  - **办公室**: 板房办公室
  - **电梯**: 垂直运输设备
- **零件编辑**: 位置调整、旋转、尺寸修改、删除

#### 5. 库道设计
- **库道绘制**: 交互式库道路径绘制
- **路径编辑**: 添加、删除路径点
- **宽度配置**: 可配置库道宽度
- **路径管理**: 支持多条库道路径

#### 6. 3D 可视化
- **视角控制**: 
  - 前视图、顶视图、侧视图
  - 等轴测视图
  - 近距离视图
  - 重置视图
- **交互控制**: 
  - 自由旋转（鼠标拖拽）
  - 平移（鼠标中键/右键）
  - 缩放（滚轮）
- **缩放控制**: 放大、缩小、重置缩放比例
- **吸附功能**: 开启/关闭网格吸附

#### 7. 测量工具
- **距离测量**: 在 3D 场景中测量两点间距离
- **可视化标注**: 测量结果实时显示

#### 8. 配置管理
- **导入导出**: 支持 JSON 格式配置文件的导入导出
- **自动保存**: 配置变更自动保存
- **数据持久化**: 
  - 仓库配置保存到 `warehouse_config.json`
  - SKU 数据保存到 SQLite 数据库 `sku_data.db`

#### 9. 实时统计
- **库位统计**: 总库位数、已占用数、空闲数实时显示
- **SKU 统计**: SKU 总数统计
- **零件统计**: 各类零件数量统计
- **状态栏**: 底部实时显示系统运行状态

### 🎨 用户界面

- **导航栏**: 顶部提供全局操作入口（导出、导入、重置视图、模式切换等）
- **控制面板**: 左侧固定宽度面板，集成所有功能控制
- **3D 场景**: 主内容区，3D 可视化核心展示区域
- **状态栏**: 底部实时显示系统运行状态和统计信息
- **信息面板**: 右侧浮动面板，显示选中对象详细信息
- **模态框**: SKU 配置、货物选择等功能的弹窗界面
- **暗色主题**: 现代化暗色主题界面设计

## 技术架构

### 后端技术栈
- **框架**: Python Flask 2.3.3
- **数据库**: SQLite3（存储 SKU 和货物数据）
- **图像处理**: Pillow 10.1.0（图片上传、缩略图生成）
- **跨域支持**: Flask-CORS 4.0.0
- **数据处理**: NumPy 1.24.3

### 前端技术栈
- **3D 引擎**: Three.js r128
- **控制器**: OrbitControls（相机控制）
- **架构**: 模块化 JavaScript（ES6+）
- **UI**: 原生 HTML/CSS/JavaScript

### 数据存储
- **配置文件**: JSON 格式（`warehouse_config.json`）
- **数据库**: SQLite（`sku_data.db`）
- **静态资源**: 
  - SKU 图片: `static/uploads/sku_images/`
  - 缩略图: `static/uploads/sku_thumbnails/`

### 模块化架构

前端代码采用模块化设计，主要模块包括：

| 模块 | 文件 | 功能 |
|------|------|------|
| 核心模块 | `core.js` | Three.js 场景初始化、渲染循环 |
| 事件模块 | `events.js` | 用户交互事件处理 |
| 货架模块 | `shelf.js` | 货架 3D 模型创建与管理 |
| 信息模块 | `info.js` | 信息显示与 UI 交互 |
| 控制模块 | `control.js` | 业务逻辑控制与 API 交互 |
| 环境模块 | `environment.js` | 环境配置与渲染 |
| 零件模块 | `parts.js` | 环境零件管理 |
| SKU 模块 | `sku.js` | SKU 配置管理 |
| 货物模块 | `cargo.js` | 货物放置与管理 |
| 库道模块 | `aisle.js` | 库道路径设计 |
| 测量模块 | `measure.js` | 距离测量工具 |

## 安装运行

### 环境要求
- Python 3.7+
- 现代浏览器（支持 WebGL）
- 推荐浏览器: Chrome、Firefox、Edge（最新版本）

### 快速开始

1. **克隆项目**
```bash
git clone <repository-url>
cd warehouse-design-system
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **运行系统**
```bash
# 方式一：直接运行
python app.py

# 方式二：使用启动脚本（Linux/Mac）
chmod +x start_debug.sh
./start_debug.sh

# 方式三：使用 Python 模块方式
python -m app
```

4. **访问应用**
打开浏览器访问: http://localhost:5002

### 项目结构
```
warehouse-design-system/
├── app.py                  # Flask 主应用
├── requirements.txt        # Python 依赖
├── README.md              # 项目说明
├── warehouse_config.json   # 仓库配置文件
├── sku_config.json        # SKU 配置文件（已废弃，使用数据库）
├── sku_data.db           # SQLite 数据库（SKU 和货物数据）
├── start_debug.sh        # 启动脚本
├── templates/
│   └── index.html        # 主页面模板
└── static/
    ├── js/               # JavaScript 模块
    │   ├── main.js       # 主模块加载器
    │   ├── core.js       # 核心 Three.js 功能
    │   ├── events.js     # 事件处理
    │   ├── shelf.js      # 货架管理
    │   ├── control.js    # 控制逻辑
    │   ├── info.js       # 信息显示
    │   ├── environment.js # 环境配置
    │   ├── parts.js      # 零件管理
    │   ├── sku.js        # SKU 管理
    │   ├── cargo.js      # 货物管理
    │   ├── aisle.js      # 库道设计
    │   └── measure.js    # 测量工具
    └── uploads/          # 上传文件目录
        ├── sku_images/   # SKU 图片
        └── sku_thumbnails/ # SKU 缩略图
```

## 使用指南

### 基本操作流程

#### 1. 初始化仓库布局
1. 在"全局参数设置"中配置库区数量、通道数量、层数、格口数量
2. 点击"初始化布局"生成默认货架布局
3. 或手动点击"添加货架"逐个添加货架单元

#### 2. 配置 SKU（货物种类）
1. 点击导航栏"📦 SKU配置"按钮
2. 在 SKU 配置模态框中：
   - 填写货物名称、编码、尺寸、重量
   - 上传单张图片或多面贴图（6个面）
   - 点击"添加SKU"保存
3. SKU 数据会自动保存到数据库

#### 3. 放置货物
1. 点击"📦 添加货物"按钮
2. 在货物选择模态框中选择要放置的 SKU
3. 点击"开始放置"
4. 在 3D 场景中点击货架层板或其他货物表面放置货物
5. 货物会自动堆叠在支撑面上

#### 4. 设计环境
1. 在"环境零件"面板中选择零件类型
2. 点击"放置零件"或"划线墙面"
3. 在 3D 场景中点击放置位置
4. 使用"选中零件控制"面板调整位置、旋转、尺寸

#### 5. 设计库道
1. 在"环境零件"面板中设置库道宽度
2. 点击"🛤️ 铺设库道"进入库道绘制模式
3. 在场景中点击多个点创建库道路径
4. 使用"删除点"或"清空所有"管理路径

#### 6. 调整视角
- 使用鼠标拖拽进行旋转
- 使用滚轮进行缩放
- 使用右侧视角按钮快速切换标准视图
- 点击"重置视图"恢复默认视角

#### 7. 导入导出配置
- **导出配置**: 点击导航栏"导出配置"，将当前布局保存为 JSON 文件
- **导入配置**: 点击导航栏"导入配置"，从 JSON 文件加载之前保存的布局

### 高级功能

#### 货架操作
- **多选**: Shift + 单击选择多个货架
- **对齐**: 选中货架后使用对齐按钮（前、后、左、右）
- **等距分布**: 选中多个货架后使用等距分布功能
- **精确调整**: 在"选中货架控制"面板中输入精确坐标和尺寸

#### 货物操作
- **选择货物**: 单击货物进行选择
- **移动货物**: 拖拽货物到新位置
- **删除货物**: 选中货物后点击"删除货物"
- **自动堆叠**: 货物会自动检测支撑面并堆叠

#### 测量工具
- 启用测量模式后，在场景中点击两点进行距离测量
- 测量结果会实时显示在场景中

## API 接口

### 配置相关
- `GET /api/config` - 获取配置
- `POST /api/config` - 更新配置
- `POST /api/config/global` - 更新全局参数
- `POST /api/export` - 导出配置
- `POST /api/import` - 导入配置

### 货架相关
- `GET /api/shelves` - 获取所有货架
- `POST /api/shelves` - 创建货架
- `PUT /api/shelves/<id>` - 更新货架
- `DELETE /api/shelves/<id>` - 删除货架

### SKU 相关
- `GET /api/skus` - 获取 SKU 列表（支持分页和搜索）
- `GET /api/skus/count` - 获取 SKU 总数
- `GET /api/skus/<id>` - 获取单个 SKU
- `POST /api/skus` - 创建 SKU
- `PUT /api/skus/<id>` - 更新 SKU
- `DELETE /api/skus/<id>` - 删除 SKU
- `POST /api/skus/batch-delete` - 批量删除 SKU
- `POST /api/skus/upload-image` - 上传 SKU 图片
- `POST /api/skus/upload-textures` - 上传多面贴图

### 货物相关
- `GET /api/cargos` - 获取所有货物
- `POST /api/cargos` - 创建货物
- `PUT /api/cargos/<id>` - 更新货物位置
- `DELETE /api/cargos/<id>` - 删除货物
- `POST /api/cargos/clear` - 清空所有货物

### 统计相关
- `GET /api/statistics` - 获取统计信息

## 开发说明

### 自定义配置

系统配置保存在 `warehouse_config.json` 文件中，包含：
- 全局参数设置（库区数量、通道数量等）
- 货架单元数据
- 视角设置
- 环境配置（空间尺寸、颜色等）
- 零件数据
- 库道路径数据

### 数据库结构

#### SKU 表 (skus)
- `id`: SKU ID（主键）
- `name`: 货物名称
- `sku_code`: SKU 编码（唯一）
- `length`, `width`, `height`: 尺寸（米）
- `weight`: 重量（kg）
- `image`: 单张图片文件名
- `thumbnail`: 缩略图文件名
- `texture_top/bottom/front/back/left/right`: 多面贴图文件名
- `created_at`, `updated_at`: 时间戳

#### 货物表 (cargos)
- `id`: 货物 ID（主键）
- `sku_id`: 关联的 SKU ID
- `x`, `y`, `z`: 位置坐标
- `rotation`: 旋转角度
- `created_at`: 创建时间

### 扩展功能

可以通过修改以下文件来自定义功能：
- `app.py`: 后端 API 和业务逻辑
- `static/js/*.js`: 前端各功能模块
- `templates/index.html`: 用户界面布局

### 模块化开发

项目采用模块化架构，每个功能模块独立：
- 模块通过全局命名空间通信
- 使用 `window.ModuleName` 访问模块
- 保持向后兼容性，旧接口仍然可用

## 常见问题

### Q: 如何重置所有数据？
A: 删除 `warehouse_config.json` 和 `sku_data.db` 文件，重启应用即可。

### Q: 图片上传失败怎么办？
A: 检查 `static/uploads/` 目录权限，确保应用有写入权限。

### Q: 3D 场景不显示？
A: 检查浏览器是否支持 WebGL，更新浏览器到最新版本。

### Q: 如何备份数据？
A: 导出配置文件（JSON）和备份 `sku_data.db` 数据库文件。

## 许可证

MIT License

## 支持

如有问题或建议，请提交 Issue 或联系开发团队。

## 更新日志

### v2.0
- ✅ 模块化架构重构
- ✅ SKU 管理系统（SQLite 数据库）
- ✅ 多面贴图支持
- ✅ 货物自动堆叠
- ✅ 环境零件系统
- ✅ 库道设计功能
- ✅ 测量工具

### v1.0
- ✅ 基础货架布局设计
- ✅ 3D 可视化
- ✅ 配置导入导出
